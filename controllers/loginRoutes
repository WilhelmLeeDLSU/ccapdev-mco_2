const User = require('../models/userModel');

module.exports.add = function(server) {
    server.get('/login', function(req, resp){
        resp.render('login',{
            layout: 'index',
            title: 'Login'
        });
    });

    server.post('/login', async function(req, resp){
        try {
            const { username, password } = req.body;
            const user = await User.findOne({ username });

            if(!user || user.password !== password) {
                return resp.status(401).send("Invalid username or password");
            }

            console.log("User logged in:", user.username);

            resp.redirect(`/?currentuser=${encodeURIComponent(user.username)}`);

        } catch (error) {
            console.error("Login error: ", error);
        }
    
    });
    
    server.get('/logout',function(req, resp){
        resp.redirect('/?currentuser=');
    })

    server.get('/register', function(req, resp){
        resp.render('register',{
            layout: 'index',
            title: 'Register', 
        });
    });

    server.post('/register', async function(req, resp){
        try {
            const { email, username, profileName, password, confirmPassword } = req.body;

            if (password !== confirmPassword) {
                return resp.send(`<script>alert('Passwords do not match'); window.location.href='/register';</script>`);
            }

            const newUser = new User({ email, username, profileName, password });
            const savedUser = await newUser.save();

            console.log("User registered:", savedUser.username);

            resp.redirect(`/login`);
        } catch (error) {
            console.error("Registration error: ", error);
            resp.status(500).send("Error registering new user");
        }
    });
}